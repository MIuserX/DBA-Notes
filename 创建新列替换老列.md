```shell
####``<1> 查看原类型``\dT+ entity_type` `<2> 确认新操作``增加一个新枚举值` `<3> 新建类型``CREATE` `TYPE entity_type_new ``AS` `ENUM (``'hotelName'``,``'poi'``,``'bizZone'``,``'subway'``,``'tradingArea'``,``'city'``,``'brand'``,``'group'``,``'grade'``,``'roomType'``,``'hotelTag'``,``'theme'``,``'facility'``,``'subjectTag'``,``'commentsTag'``,``'flagship'``,``'stopWord'``,``'poiWord'``,``'region'``,``'professionWord'``,``'hotelCoreWord'``,``'fuzzyEntity'``,``'breakFast'``,``'newRoomType'``, ``'supplementPoi'``);` `<4> 表新加列``alter` `table` `hs_entity_index ``add` `column` `entity_type_new entity_type_new;` `<5> 为表的新列新加索引``create` `index` `CONCURRENTLY ``on` `hs_entity_index (entity_type_new, data_version ``DESC``);``create` `index` `CONCURRENTLY ``on` `hs_entity_index (entity_type_new, channel, data_version ``DESC``);` `<6> 新建触发器``CREATE` `FUNCTION` `update_sync_newval() ``RETURNS` `trigger``AS` `$$``DECLARE``  ``new_val entity_type_new;``BEGIN` `END``;``$$ LANGUAGE plpgsql;` `CREATE` `FUNCTION` `insert_sync_newval() ``RETURNS` `trigger``AS` `$$``DECLARE``  ``new_val entity_type_new;``BEGIN``  ``IF NEW.entity_type = ``'hotelName'``::entity_type ``THEN``    ``new_val = ``'hotelName'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'poi'``::entity_type ``THEN``    ``new_val = ``'poi'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'bizZone'``::entity_type ``THEN``    ``new_val = ``'bizZone'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'subway'``::entity_type ``THEN``    ``new_val = ``'subway'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'tradingArea'``::entity_type ``THEN``    ``new_val = ``'tradingArea'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'city'``::entity_type ``THEN``    ``new_val = ``'city'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'brand'``::entity_type ``THEN``    ``new_val = ``'brand'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'group'``::entity_type ``THEN``    ``new_val = ``'group'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'grade'``::entity_type ``THEN``    ``new_val = ``'grade'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'roomType'``::entity_type ``THEN``    ``new_val = ``'roomType'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'hotelTag'``::entity_type ``THEN``    ``new_val = ``'hotelTag'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'theme'``::entity_type ``THEN``    ``new_val = ``'theme'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'facility'``::entity_type ``THEN``    ``new_val = ``'facility'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'subjectTag'``::entity_type ``THEN``    ``new_val = ``'subjectTag'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'commentsTag'``::entity_type ``THEN``    ``new_val = ``'commentsTag'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'flagship'``::entity_type ``THEN``    ``new_val = ``'flagship'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'stopWord'``::entity_type ``THEN``    ``new_val = ``'stopWord'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'poiWord'``::entity_type ``THEN``    ``new_val = ``'poiWord'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'region'``::entity_type ``THEN``    ``new_val = ``'region'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'professionWord'``::entity_type ``THEN``    ``new_val = ``'professionWord'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'hotelCoreWord'``::entity_type ``THEN``    ``new_val = ``'hotelCoreWord'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'fuzzyEntity'``::entity_type ``THEN``    ``new_val = ``'fuzzyEntity'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'breakFast'``::entity_type ``THEN``    ``new_val = ``'breakFast'``::entity_type_new;``  ``ELSIF NEW.entity_type = ``'newRoomType'``::entity_type ``THEN``    ``new_val = ``'newRoomType'``::entity_type_new;``  ``ELSE``    ``new_val = ``null``;``  ``END` `IF;``  ``NEW.entity_type_new := new_val;``  ``RETURN` `NEW;``END``;``$$ LANGUAGE plpgsql;` `create` `trigger` `update_sync_trig before ``update` `of` `entity_type ``on` `hs_entity_index ``for` `each row ``execute` `procedure` `insert_sync_newval();` `create` `trigger` `insert_sync_trig before ``insert` `on` `hs_entity_index ``for` `each row ``execute` `procedure` `insert_sync_newval();` `<7> 给新列刷数据(循环)``update` `hs_entity_index ``set` `entity_type_new = (``case``  ``when` `entity_type = ``'hotelName'``::entity_type ``then` `'hotelName'``::entity_type_new``  ``when` `entity_type = ``'poi'``::entity_type ``then` `'poi'``::entity_type_new``  ``when` `entity_type = ``'bizZone'``::entity_type ``then` `'bizZone'``::entity_type_new``  ``when` `entity_type = ``'subway'``::entity_type ``then` `'subway'``::entity_type_new``  ``when` `entity_type = ``'tradingArea'``::entity_type ``then` `'tradingArea'``::entity_type_new``  ``when` `entity_type = ``'city'``::entity_type ``then` `'city'``::entity_type_new``  ``when` `entity_type = ``'brand'``::entity_type ``then` `'brand'``::entity_type_new``  ``when` `entity_type = ``'group'``::entity_type ``then` `'group'``::entity_type_new``  ``when` `entity_type = ``'grade'``::entity_type ``then` `'grade'``::entity_type_new``  ``when` `entity_type = ``'roomType'``::entity_type ``then` `'roomType'``::entity_type_new``  ``when` `entity_type = ``'hotelTag'``::entity_type ``then` `'hotelTag'``::entity_type_new``  ``when` `entity_type = ``'theme'``::entity_type ``then` `'theme'``::entity_type_new``  ``when` `entity_type = ``'facility'``::entity_type ``then` `'facility'``::entity_type_new``  ``when` `entity_type = ``'subjectTag'``::entity_type ``then` `'subjectTag'``::entity_type_new``  ``when` `entity_type = ``'commentsTag'``::entity_type ``then` `'commentsTag'``::entity_type_new``  ``when` `entity_type = ``'flagship'``::entity_type ``then` `'flagship'``::entity_type_new``  ``when` `entity_type = ``'stopWord'``::entity_type ``then` `'stopWord'``::entity_type_new``  ``when` `entity_type = ``'poiWord'``::entity_type ``then` `'poiWord'``::entity_type_new``  ``when` `entity_type = ``'region'``::entity_type ``then` `'region'``::entity_type_new``  ``when` `entity_type = ``'professionWord'``::entity_type ``then` `'professionWord'``::entity_type_new``  ``when` `entity_type = ``'hotelCoreWord'``::entity_type ``then` `'hotelCoreWord'``::entity_type_new``  ``when` `entity_type = ``'fuzzyEntity'``::entity_type ``then` `'fuzzyEntity'``::entity_type_new``  ``when` `entity_type = ``'breakFast'``::entity_type ``then` `'breakFast'``::entity_type_new``  ``when` `entity_type = ``'newRoomType'``::entity_type ``then` `'newRoomType'``::entity_type_new``  ``else` `null``end``)``where` `id ``in` `(``select` `id ``from` `hs_entity_index ``where` `entity_type_new ``is` `null` `limit 10000);` `<8> 新建唯一索引` `<9> 交换新老列名字(一个事务)``测试``begin``;``drop` `trigger` `insert_sync_trig ``on` `enumtest;``drop` `trigger` `update_sync_trig ``on` `enumtest;``alter` `table` `enumtest rename ``column` `entity_type ``to` `entity_type_old;``alter` `table` `enumtest rename ``column` `entity_type_new ``to` `entity_type;``alter` `type entity_type rename ``to` `entity_type_old;``alter` `type entity_type_new rename ``to` `entity_type;``end``;` `begin``;``alter` `table` `enumtest rename ``column` `entity_type ``to` `entity_type_new;``alter` `table` `enumtest rename ``column` `entity_type_old ``to` `entity_type;``alter` `type entity_type rename ``to` `entity_type_new;``alter` `type entity_type_old rename ``to` `entity_type;``end``;` `create` `trigger` `update_sync_trig before ``update` `of` `entity_type ``on` `enumtest ``for` `each row ``execute` `procedure` `insert_sync_newval();``create` `trigger` `insert_sync_trig before ``insert` `on` `enumtest ``for` `each row ``execute` `procedure` `insert_sync_newval();`  `正式``begin``;``drop` `trigger` `insert_sync_trig ``on` `hs_entity_index;``drop` `trigger` `update_sync_trig ``on` `hs_entity_index;``alter` `table` `hs_entity_index rename ``column` `entity_type ``to` `entity_type_old;``alter` `table` `hs_entity_index rename ``column` `entity_type_new ``to` `entity_type;``alter` `type entity_type rename ``to` `entity_type_old;``alter` `type entity_type_new rename ``to` `entity_type;``end``;` `预备回滚``begin``;``alter` `table` `hs_entity_index rename ``column` `entity_type ``to` `entity_type_new;``alter` `table` `hs_entity_index rename ``column` `entity_type_old ``to` `entity_type;``alter` `type entity_type rename ``to` `entity_type_new;``alter` `type entity_type_old rename ``to` `entity_type;``end``;` `create` `trigger` `update_sync_trig before ``update` `of` `entity_type ``on` `hs_entity_index ``for` `each row ``execute` `procedure` `insert_sync_newval();``create` `trigger` `insert_sync_trig before ``insert` `on` `hs_entity_index ``for` `each row ``execute` `procedure` `insert_sync_newval();` `<10> 删除老列、老索引
```