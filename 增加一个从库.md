[TOC]



# Case 1：一套没备份的集群，加一个从库

### 概述

一般需要两个过程，一是复制主库的数据到从库，二是启动从库连上主库进行流复制。



### 复制数据

#### 步骤1

主库执行如下 SQL：

```
select` `pg_start_backup(``'label'``, ``true``);
```



#### 步骤2

从库执行接收数据的命令：

```
#### 从库机器上执行如下命令：` `# 切到root``sudo` `-s ` `# 切到要放置数据的目录，``# 一般DB数据目录放置在 /export 下，上一步切换 root 是为了``cd` `/export` `# 执行接收数据的命令``nc -l 54321 | ``tar` `-xvf -
```

#### 步骤3

```
#### 主库机器上执行如下命令：` `# 切到DB数据目录所在目录``cd` `/export` `# 执行发送数据的命令(下面以pg100_data这个数据目录为例子)``# 下面命令中的 slave_host 要换成实际接收数据的 hostname ``# pv -tabL 50m 是限速每秒 50MB 的意思``tar` `-cf - pg100_data --exclude=pg100_data``/log/``* | pv -tabL 50m | nc slave_host 54321
```



#### 步骤4

主库执行如下 SQL：

```
-- 注意：主库不执行这一步，就启动了新从库，会导致新从库不接受连接，``--   但问题并不大，只要主库执行这个命令，新从库会立刻接受连接。``--``select` `pg_stop_backup();
```

#### 步骤5

用复制过来的数据目录启动从库。





# Case 2：一套有备份的集群，加一个从库

--todo



# 总论

加一个从库这事本质上，是弄一个可以跟的上主库的从节点。

那么从节点要搞起来：

1. 有从最开始的所有wal，一直replay到当前，然后跟着主库
2. 找一个从开始到目前之间的某个时间点的基础备份，再加上这个时间点到现在的wal
3. 直接把主库或其他已有从库的数据目录复制过来，然后跟上主库

当然，如果库已经运行很久了，1方案明显不如2方案。



